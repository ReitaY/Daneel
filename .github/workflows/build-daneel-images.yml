name: Build & Push Daneel base/desktop images

on:
  # 手動トリガ専用
  workflow_dispatch: {}

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    # GHCR への push に必要
    permissions:
      contents: read
      packages: write

    # humble / jazzy / rolling をそれぞれ並列ビルド
    strategy:
      fail-fast: false
      matrix:
        ros_distro: [humble, jazzy, rolling]

    env:
      # 出力先の GHCR プレフィックス
      # → ghcr.io/<owner>/daneel/...
      IMAGE_PREFIX: ghcr.io/${{ toLower(github.repository_owner) }}/daneel

      # マルチアーキ
      PLATFORMS: linux/amd64,linux/arm64

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up QEMU (for multi-arch)
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          # 自動で渡されるトークン。GHCR に push する権限あり
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push base and desktop images
        run: |
          set -eux

          DISTRO="${{ matrix.ros_distro }}"

          BASE_IMAGE="${IMAGE_PREFIX}/base:${DISTRO}"
          DESKTOP_IMAGE="${IMAGE_PREFIX}/desktop:${DISTRO}"

          echo "=== Building ROS_DISTRO=${DISTRO} ==="
          echo "BASE_IMAGE    = ${BASE_IMAGE}"
          echo "DESKTOP_IMAGE = ${DESKTOP_IMAGE}"
          echo "PLATFORMS     = ${PLATFORMS}"
          echo

          # 1) base イメージ
          docker buildx build \
            --platform "${PLATFORMS}" \
            --build-arg "ROS_DISTRO=${DISTRO}" \
            -t "${BASE_IMAGE}" \
            -f "docker/base/Dockerfile" \
            "docker/base" \
            --push

          # 2) desktop イメージ
          docker buildx build \
            --platform "${PLATFORMS}" \
            --build-arg "BASE_IMAGE=${BASE_IMAGE}" \
            -t "${DESKTOP_IMAGE}" \
            -f "docker/desktop/Dockerfile" \
            "docker/desktop" \
            --push

          echo "=== Smoke test on host arch (amd64) ==="

          # 3) base: ros2 -h だけ叩いてみる
          docker run --rm "${BASE_IMAGE}" bash -lc 'ros2 -h >/dev/null 2>&1'

          # 4) desktop: /opt/ros/${DISTRO}/setup.bash が読めるかチェック
          docker run --rm --entrypoint bash "${DESKTOP_IMAGE}" -lc "source /opt/ros/${DISTRO}/setup.bash && ros2 -h >/dev/null 2>&1"

          echo ">>> OK: ${DISTRO} (multi-arch base + desktop)"
