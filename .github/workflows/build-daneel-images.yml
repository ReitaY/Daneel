name: Build & Push Daneel base/desktop images

on:
  workflow_dispatch: {}

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    strategy:
      fail-fast: false
      matrix:
        ros_distro: [humble, jazzy, rolling]

    env:
      PLATFORMS: linux/amd64,linux/arm64

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up QEMU (for multi-arch)
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push base and desktop images
        run: |
          set -eux

          DISTRO="${{ matrix.ros_distro }}"

          # GitHub がくれる env を使う
          # 大文字を含んでいても、ここで全部小文字に潰す
          OWNER_LC="$(echo "${GITHUB_REPOSITORY_OWNER}" | tr '[:upper:]' '[:lower:]')"

          # ここでパスを組み立てる
          IMAGE_PREFIX="ghcr.io/${OWNER_LC}/daneel"

          BASE_IMAGE="${IMAGE_PREFIX}-base:${DISTRO}"
          DESKTOP_IMAGE="${IMAGE_PREFIX}-desktop:${DISTRO}"

          echo "=== Building ROS_DISTRO=${DISTRO} ==="
          echo "OWNER        = ${GITHUB_REPOSITORY_OWNER}"
          echo "OWNER_LC     = ${OWNER_LC}"
          echo "BASE_IMAGE   = ${BASE_IMAGE}"
          echo "DESKTOP_IMG  = ${DESKTOP_IMAGE}"
          echo "PLATFORMS    = ${PLATFORMS}"
          echo

          docker buildx build \
            --platform "${PLATFORMS}" \
            --build-arg "ROS_DISTRO=${DISTRO}" \
            -t "${BASE_IMAGE}" \
            -f "docker/base/Dockerfile" \
            "docker/base" \
            --push

          docker buildx build \
            --platform "${PLATFORMS}" \
            --build-arg "BASE_IMAGE=${BASE_IMAGE}" \
            -t "${DESKTOP_IMAGE}" \
            -f "docker/desktop/Dockerfile" \
            "docker/desktop" \
            --push

          echo "=== Smoke test on host arch (amd64) ==="

          docker run --rm "${BASE_IMAGE}" bash -lc 'ros2 -h >/dev/null 2>&1'

          docker run --rm --entrypoint bash "${DESKTOP_IMAGE}" -lc "source /opt/ros/${DISTRO}/setup.bash && ros2 -h >/dev/null 2>&1"

          echo ">>> OK: ${DISTRO} (multi-arch base + desktop)"
